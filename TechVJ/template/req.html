<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>LumosFlix Player</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Video.js core CSS -->
  <link href="https://vjs.zencdn.net/7.21.0/video-js.css" rel="stylesheet" />
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family:'Poppins',sans-serif; user-select:none; -webkit-user-drag:none; }
    *:focus, *:focus-visible, button::-moz-focus-inner, :-moz-focusring { outline:none!important; box-shadow:none!important; border:0!important; }
    * { -webkit-tap-highlight-color: transparent!important; }

    header {
      background: linear-gradient(135deg,#000 0%,#2d0a0a 100%);
      padding:1rem; text-align:center; position:sticky; top:0; z-index:100;
      box-shadow:0 4px 15px rgba(229,9,20,0.1);
    }
    .logo { font-size:1.75rem; font-weight:700; background:linear-gradient(45deg,#e50914,#ff6b6b); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .subtitle {
      margin-top:0.25rem; font-size:0.9rem; color:#aaa; position:relative;
    }
    .subtitle::after {
      content:'â†“'; display:block; text-align:center; margin-top:4px; font-size:1.25rem; color:#888; animation:bounce 2s infinite;
    }
    @keyframes bounce { 0%,100%{transform:translateY(0);}50%{transform:translateY(4px);} }

    .video-wrapper {
      position:fixed; top:100px; left:0; right:0; bottom:60px; background:#000; z-index:1;
    }
    /* Loading overlay and spinner */
    #loading {
      position:fixed; top:100px; left:0; right:0; bottom:60px; background:rgba(0,0,0,0.85); z-index:9999;
      display:none; align-items:center; justify-content:center;
    }
    #loading .spinner {
      width:80px; height:80px;
      border:8px solid rgba(255,255,255,0.2);
      border-top:8px solid #e50914;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }

    .share-container {
      position:fixed; bottom:0; left:0; right:0; display:flex; justify-content:space-between; align-items:center;
      padding:calc(0.5rem + env(safe-area-inset-bottom,0)) 1rem; background:rgba(0,0,0,0.7); z-index:100;
    }
    .action-button { padding:0.75rem 1.5rem; border:none; border-radius:30px; font-size:1rem; font-weight:500;
      cursor:pointer; display:flex; align-items:center; gap:0.5rem; transition:transform 0.3s,box-shadow 0.3s;
    }
    #shareBtn { background:linear-gradient(45deg,#e50914,#b20710); color:#fff; }
    #shareBtn:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(229,9,20,0.4); }
    #shareBtn:active { transform:scale(0.95); box-shadow:0 2px 8px rgba(229,9,20,0.3); }
    #joinTelegram { background:linear-gradient(135deg,#37aee2,#1a7ec8); color:#fff; }
    #joinTelegram:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,0.3); }
    #joinTelegram:active { transform:scale(0.95); box-shadow:0 2px 8px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
  <header>
    <div class="logo">LumosFlix</div>
    <div class="subtitle">If there is a loading problem, do a refresh.</div>
  </header>

  <div class="video-wrapper">
    <video id="player" class="video-js vjs-default-skin" controls autoplay muted playsinline preload="auto"></video>
  </div>
  <!-- Loading animation (first-time only) -->
  <div id="loading"><div class="spinner"></div></div>

  <div class="share-container">
    <button id="shareBtn" class="action-button"><i class="fas fa-share-alt"></i> Share</button>
    <button id="joinTelegram" class="action-button" onclick="window.open('telegram.html','_blank')">
      <i class="fab fa-telegram-plane"></i> Join us
    </button>
  </div>

  <!-- Libraries -->
  <script src="https://vjs.zencdn.net/7.21.0/video.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-matroska/dist/videojs-matroska.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const fileUrl = '{{file_url}}';
    const videoEl = document.getElementById('player');
    const player = videojs(videoEl, { techOrder:['html5'], autoplay:true });

    let isFirstLoad = true;
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }

    player.ready(() => {
      // Show loading on initial load
      showLoading(true);

      const isMkv = fileUrl.toLowerCase().endsWith('.mkv');
      const isHls = fileUrl.toLowerCase().endsWith('.m3u8');

      if (isMkv) {
        player.tech().options_ = player.tech().options_ || {};
        player.tech().options_.matroska = { chunkSize:4*1024*1024 };
        player.src({ src:fileUrl, type:'video/x-matroska' });
        player.play().catch(()=>{});

      } else if (isHls) {
        if (Hls.isSupported()) {
          const hls = new Hls({
            maxBufferLength: 60,
            maxMaxBufferLength: 120,
            maxBufferSize: 1024 * 1024 * 512,
            backBufferLength: 30,
            startFragPrefetch: true,
            maxBufferHole: 0.5,
            lowLatencyMode: true,
          });
          hls.on(Hls.Events.ERROR, (event, data) => console.warn('HLS error', data));
          hls.loadSource(fileUrl);
          hls.attachMedia(videoEl);
          hls.on(Hls.Events.MANIFEST_PARSED, () => videoEl.play());
        } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
          videoEl.src = fileUrl;
        }

      } else {
        player.src({ src:fileUrl, type:'video/mp4' });
        player.play().catch(()=>{});
      }

      // Hide loading after first play
      player.on('playing', () => {
        showLoading(false);
        isFirstLoad = false;
      });
      // Buffering events ignored after initial load
      player.on('waiting', () => {
        if (isFirstLoad) {
          showLoading(true);
        }
      });
    });

    // Share button
    document.getElementById('shareBtn').addEventListener('click', async() => {
      try { await navigator.clipboard.writeText(window.location.href); alert('Shareable link copied!'); }
      catch { alert('Failed to copy link.'); }
    });
  </script>
</body>
</html>
