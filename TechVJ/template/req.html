<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>LumosFlix Player</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Video.js core CSS -->
  <link href="https://vjs.zencdn.net/7.21.0/video-js.css" rel="stylesheet" />
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; font-family:'Poppins',sans-serif; user-select:none; -webkit-user-drag:none; }
    *:focus, *:focus-visible, button::-moz-focus-inner, :-moz-focusring { outline:none!important; box-shadow:none!important; border:0!important; }
    * { -webkit-tap-highlight-color: transparent!important; }

    /* Loading overlay */
    #loading {
      position:fixed;
      top:100px; left:0; right:0; bottom:60px;
      background:rgba(0,0,0,0.8);
      z-index:9999;
      display:none;
      align-items:center;
      justify-content:center;
      font-size:1.5rem;
      color:#fff;
    }

    /* Video container */
    .video-wrapper { position:fixed; top:100px; left:0; right:0; bottom:60px; background:#000; z-index:1; }
    .video-js { width:100%; height:100%; }

    /* Controls container */
    .share-container {
      position:fixed;
      bottom:0; left:0; right:0;
      display:flex; justify-content:space-between; align-items:center;
      padding:calc(0.5rem + env(safe-area-inset-bottom,0)) 1rem;
      background:rgba(0,0,0,0.7);
      z-index:100;
    }
    .action-button {
      padding:0.75rem 1.5rem;
      border:none; border-radius:30px;
      font-size:1rem; font-weight:500;
      cursor:pointer;
      display:flex; align-items:center; gap:0.5rem;
      transition:transform 0.3s, box-shadow 0.3s;
    }
    #shareBtn { background:linear-gradient(45deg,#e50914,#b20710); color:#fff; }
    #shareBtn:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(229,9,20,0.4); }
    #shareBtn:active { transform:scale(0.95); box-shadow:0 2px 8px rgba(229,9,20,0.3); }
    #joinTelegram { background:linear-gradient(135deg,#37aee2,#1a7ec8); color:#fff; }
    #joinTelegram:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,0.3); }
    #joinTelegram:active { transform:scale(0.95); box-shadow:0 2px 8px rgba(0,0,0,0.2); }

    /* Audio language selector */
    #langSelectContainer {
      display:flex; align-items:center; gap:0.25rem; font-size:0.9rem; color:#fff;
    }
    #langSelect {
      padding:0.5rem; border-radius:20px;
      background:rgba(255,255,255,0.1); color:#fff; border:none;
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loading">Loading...</div>

  <!-- Video wrapper -->
  <div class="video-wrapper">
    <video id="player" class="video-js vjs-big-play-centered" controls autoplay>
      <source src="{{file_url}}" type="application/vnd.apple.mpegurl">
    </video>
  </div>

  <!-- Controls and actions -->
  <div class="share-container">
    <button id="shareBtn" class="action-button"><i class="fas fa-share-alt"></i> Share</button>
    <div id="langSelectContainer" class="action-button">
      <label for="langSelect"><i class="fas fa-language"></i></label>
      <select id="langSelect" disabled><option>Loadingâ€¦</option></select>
    </div>
    <button id="joinTelegram" class="action-button" onclick="window.open('telegram.html','_blank')">
      <i class="fab fa-telegram-plane"></i> Join us
    </button>
  </div>

  <!-- Libraries -->
  <script src="https://vjs.zencdn.net/7.21.0/video.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-matroska/dist/videojs-matroska.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const fileUrl = '{{file_url}}';
    const videoEl = document.getElementById('player');
    const player = videojs(videoEl, { techOrder:['html5'] });

    // Loading overlay
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }

    player.ready(() => {
      // Autoplay & unmute by default
      player.autoplay(true);
      player.muted(false);

      showLoading(true);
      const isMkv = fileUrl.toLowerCase().endsWith('.mkv');
      const isHls = fileUrl.toLowerCase().endsWith('.m3u8');

      if (isMkv) {
        player.tech().options_ = player.tech().options_ || {};
        player.tech().options_.matroska = { chunkSize:4*1024*1024 };
      } else if (isHls) {
        const hls = new Hls();
        hls.loadSource(fileUrl);
        hls.attachMedia(videoEl);
      }

      player.on('loadeddata', () => showLoading(false));
      player.on('waiting', () => showLoading(true));

      // Audio track switcher
      const tracks = player.audioTracks();
      const select = document.getElementById('langSelect');
      if (tracks && tracks.length > 0) {
        select.innerHTML = '';
        for (let i = 0; i < tracks.length; i++) {
          const t = tracks[i];
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = t.label || t.language || `Track ${i+1}`;
          select.appendChild(opt);
        }
        select.disabled = false;
        for (let i = 0; i < tracks.length; i++) {
          if (tracks[i].enabled) { select.value = i; break; }
        }
        select.addEventListener('change', () => {
          const chosen = parseInt(select.value, 10);
          for (let i = 0; i < tracks.length; i++) {
            tracks[i].enabled = (i === chosen);
          }
        });
      }
    });

    // Share button
    document.getElementById('shareBtn').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(window.location.href); alert('Shareable link copied!'); }
      catch { alert('Failed to copy link.'); }
    });
  </script>
</body>
</html>
